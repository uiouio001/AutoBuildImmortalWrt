# æ­¤å·¥ä½œæµ99% ä½¿ç”¨luci 24.10.x æ¥æž„å»º æžä¸ªåˆ«æœºåž‹ä½¿ç”¨å¿«ç…§ç‰ˆå’Œ23.05.4ç‰ˆæœ¬æ¥æž„å»º
# 23.05.4 ç‰¹æœ‰æœºåž‹åˆ—è¡¨
# abt_asr3000-ubootmod
# cetron_ct3003-stock
# cmcc_a10
# cmcc_rax3000m-emmc-ubootmod
# cmcc_rax3000m-nand-ubootmod
# imou_lc-hx3001-ubootmod
# jcg_q30 æ·æˆ
# jcg_q30-ubootmod
# qihoo_360t7-ubootmod
# xiaomi_mi-router-wr30u-112m-nmbm
# xiaomi_redmi-router-ax6000 è¯¥æœºåž‹åœ¨24.10.2 åˆ†åŒ–ä¸º2ä¸ªæœºåž‹
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”24.10.2â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# xiaomi_redmi-router-ax6000-stock â€”â€”â€”â€”åŽŸåŽ‚é»˜è®¤ bootloaderï¼ˆstockï¼‰ç‰ˆæœ¬
# xiaomi_redmi-router-ax6000-ubootmodâ€”â€”â€”â€”â€”æ”¹è£…è¿‡ bootloader çš„ç‰ˆæœ¬ï¼ˆubootmodï¼‰

name: Build Wireless Router ImmortalWrt 24.10.x

on:
  workflow_dispatch:
    inputs:
      profile:
        type: choice
        description: "è¯·é€‰æ‹©mtkè·¯ç”±å™¨åž‹å·"
        required: true
        options:
          - cmcc_rax3000m-emmc-ubootmod
          - cmcc_rax3000m-nand-ubootmod
          - cmcc_rax3000m
          - cmcc_rax3000me
        default: cmcc_rax3000m-emmc-ubootmod
      custom_router_ip:
        description: "è¯·è®¾ç½®è·¯ç”±å™¨çš„ç®¡ç†åœ°å€ æ ¼å¼:192.168.x.1 æˆ– 10.x.x.1"
        required: true
        default: "192.168.6.1"
      enable_store:
        description: "é›†æˆ iStore å•†åº—"
        required: false
        type: boolean
        default: true
      include_docker:
        description: "æ˜¯å¦ç¼–è¯‘ Dockerman æ’ä»¶"
        required: true
        default: true
        type: boolean
      USE_XR30_LED_DTS:
        description: "æ˜¯å¦ä½¿ç”¨XR30 Ledé…ç½®æ–‡ä»¶"
        required: true
        default: false
        type: boolean
      WIFI_DRIVER_VERSION:
        description: "é€‰æ‹©WiFié©±åŠ¨ç‰ˆæœ¬"
        required: true
        default: 'v7.6.7.2-fw-20240823(recommend)'
        type: choice
        options:
        - v7.6.7.2-fw-20240823(recommend)
        - v7.6.6.1-fw-20230306(recommend)
        - v7.6.7.2-fw-default
        - v7.6.7.2-fw-20230306
        - v7.6.7.2-fw-20230330
        - v7.6.7.2-fw-20230411
        - v7.6.7.2-fw-20230717
        - v7.6.7.2-fw-20231024
        - v7.6.6.1-fw-default
        - v7.6.6.1-fw-20230330
        - v7.6.6.1-fw-20230411
        - v7.6.6.1-fw-20230717
        - v7.6.6.1-fw-20231024
        - v7.6.6.1-fw-20240823
      USE_NX30PRO_EEPROM:
        description: "ä½¿ç”¨nx30proé«˜åŠŸèƒ½eepromæé«˜ä¿¡å·å¼ºåº¦"
        required: true
        default: false
        type: boolean
      enable_pppoe:
        description: "æ˜¯å¦é…ç½®PPPoEæ‹¨å·ä¿¡æ¯?"
        required: true
        default: false
        type: boolean
      pppoe_account:
        description: "å®½å¸¦è´¦å· (è‹¥å¯ç”¨PPPoE)"
        required: false
      pppoe_password:
        description: "å®½å¸¦å¯†ç  (è‹¥å¯ç”¨PPPoE)"
        required: false


jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set executable permissions
        run: |
          chmod +x ${{ github.workspace }}/mediatek-filogic/build24.sh
      
      - name: Save Custom Router IP into OpenWrt files
        run: |
          mkdir -p "${{ github.workspace }}/custom"
          echo "${{ github.event.inputs.custom_router_ip }}" > "${{ github.workspace }}/custom/custom_router_ip.txt"
          echo "æ‚¨è®¾ç½®çš„è·¯ç”±å™¨ç®¡ç†åœ°å€æ˜¯:${{ github.event.inputs.custom_router_ip }}"
          # åŽç»­æ­¥éª¤ä¼šå°†è¯¥æ–‡ä»¶æ˜ å°„åˆ°è·¯ç”±å™¨/etc/config/custom_router_ip.txt ä»¥ä¾¿ç”¨äºŽå¼€æœºè„šæœ¬99-custom.shè¯»å–ç”¨æˆ·è®¾ç½®çš„ip


      - name: Validate PPPoE Inputs
        if: github.event.inputs.enable_pppoe == 'true'
        run: |
          if [[ -z "${{ github.event.inputs.pppoe_account }}" || -z "${{ github.event.inputs.pppoe_password }}" ]]; then
            echo "Error: PPPoE account and password must be provided when PPPoE is enabled!"
            exit 1
          fi
      
      - name: Enable Store integration
        if: github.event.inputs.enable_store == 'true'
        run: |
          echo 'CUSTOM_PACKAGES="$CUSTOM_PACKAGES luci-app-store"' >> shell/custom-packages.sh
          echo "âœ… å·²è¿½åŠ  luci-app-store"
      
      - name: Set Use XR30 LED DTS file
        if: github.event.inputs.USE_XR30_LED_DTS == 'true'
        run: |
          echo "âœ… è®¾ç½®ä½¿ç”¨XR30çš„Ledé…ç½®æ–‡ä»¶"
      
      - name: Set WiFi Driver Version
        run: |
          driver_version=$(echo "${{ github.event.inputs.WIFI_DRIVER_VERSION }}" | sed -E 's/^(v[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          driver_firmware=$(echo "${{ github.event.inputs.WIFI_DRIVER_VERSION }}" | sed -E 's/.*fw-([0-9]{8}|default).*/\1/g')
          echo "wifi_driver_version=$driver_version" >> $GITHUB_ENV
          echo "wifi_driver_firmware=$driver_firmware" >> $GITHUB_ENV
          echo "âœ… æ‚¨é€‰æ‹©çš„WiFié©±åŠ¨ç‰ˆæœ¬æ˜¯: $driver_version-fw-$driver_firmware"
 
      - name: Use nx30pro eeprom and fixed WiFi MAC address
        run: |
          if [ "${{ github.event.inputs.USE_NX30PRO_EEPROM }}" == "true" ]; then
            echo "âœ… ä½¿ç”¨nx30proçš„é«˜åŠŸçŽ‡eeprom(2.4Gæ˜¯23dBmã€5Gæ˜¯22dBm)"
          else
            echo "âŽ ä½¿ç”¨é»˜è®¤åŠŸçŽ‡eeprom(2.4Gæ˜¯25dBmã€5Gæ˜¯24dBm)"
          fi
      
      - name: Build Wireless ImmortalWrt 24.10.2
        run: |
          profile="${{ github.event.inputs.profile }}"
          echo "Building for profile: $profile"
          include_docker="${{ github.event.inputs.include_docker }}"
          # é»˜è®¤å¹³å°
          echo "platform=mediatek/filogic" >> $GITHUB_ENV

          # è¯»å– ipq807x æœºåž‹æ–‡ä»¶
          ipq807x_models=$(cat mediatek-filogic/model/ipq807x.txt | tr '\n' '|')
          ipq807x_models=${ipq807x_models%|}
          if [[ "$profile" =~ ^($ipq807x_models)$ ]]; then
              case_tag="qualcommax-ipq807x-openwrt-24.10.2"
              case_platform="qualcommax/ipq807x"
          fi

          # è¯»å– mt7621 æœºåž‹æ–‡ä»¶
          mt7621_models=$(cat mediatek-filogic/model/mt7621.txt | tr '\n' '|')
          mt7621_models=${mt7621_models%|}
          if [[ "$profile" =~ ^($mt7621_models)$ ]]; then
              case_tag="ramips-mt7621-openwrt-24.10.2"
              case_platform="ramips/mt7621"
          fi

          # è¯»å– bcm53xx/generic æœºåž‹æ–‡ä»¶
          bcm53xx_models=$(cat mediatek-filogic/model/bcm53xx.txt | tr '\n' '|')
          bcm53xx_models=${bcm53xx_models%|}
          if [[ "$profile" =~ ^($bcm53xx_models)$ ]]; then
              case_tag="bcm53xx-generic-openwrt-24.10.2"
              case_platform="bcm53xx/generic"
          fi

          # åˆ¤æ–­æœºåž‹
          case "$profile" in
              glinet_gl-b2200)
                  # è™½ç„¶å®ƒæ˜¯é«˜é€šipq40xxå¹³å° ä½†ç”±äºŽéƒ½æ˜¯glæœºåž‹ æ•…æ”¾åœ¨ä¸€èµ· æ‰¾èµ·æ¥æ–¹ä¾¿
                  tag=ipq40xx-generic-openwrt-24.10.2
                  echo "platform=ipq40xx/generic" >> $GITHUB_ENV
                  ;;
              glinet_gl-axt1800|glinet_gl-ax1800)
                  # è™½ç„¶å®ƒæ˜¯é«˜é€šipq60xxå¹³å° ä½†ç”±äºŽéƒ½æ˜¯glæœºåž‹ æ•…æ”¾åœ¨ä¸€èµ· æ‰¾èµ·æ¥æ–¹ä¾¿
                  tag=qualcommax-ipq60xx-snapshot
                  echo "platform=qualcommax/ipq60xx" >> $GITHUB_ENV
                  ;;
              cudy_tr3000-256mb-v1)
                  # ç”±äºŽ256MBç‰ˆæœ¬tr3000 è¿˜æ²¡æœ‰å‡ºæ­£å¼ç‰ˆ24.10.2 æ•…ä½¿ç”¨å¿«ç…§ç‰ˆæœ¬æ¥æž„å»º
                  tag=mediatek-filogic-24.10-SNAPSHOT
                  ;;
              # ä¸‹åˆ—æœºåž‹ç›®å‰æ²¡æœ‰24.10 å› æ­¤é‡‡ç”¨23.05.4åˆ†æ”¯æ¥æž„å»º
              cmcc_rax3000m-emmc-ubootmod | \
              cmcc_rax3000m-nand-ubootmod | \
              cmcc_a10 | \
              abt_asr3000-ubootmod | \
              imou_lc-hx3001-ubootmod | \
              jcg_q30 | \
              jcg_q30-ubootmod | \
              xiaomi_mi-router-wr30u-112m-nmbm | \
              cetron_ct3003-stock | \
              xiaomi_redmi-router-ax6000 | \
              qihoo_360t7-ubootmod)
                  tag=mediatek-filogic-openwrt-23.05.4
                  ls ${{ github.workspace }}/mediatek-filogic/
                  cp ${{ github.workspace }}/mediatek-filogic/build23.sh ${{ github.workspace }}/mediatek-filogic/build24.sh
                  ;;
              *)
                  # å¦‚æžœå‰é¢åŒ¹é…äº† ipq807xã€mt7621ã€bcm53xx æœºåž‹æ–‡ä»¶ï¼Œåˆ™ä½¿ç”¨å¯¹åº” tag
                  if [[ -n "$case_tag" ]]; then
                      tag=$case_tag
                      echo "platform=$case_platform" >> $GITHUB_ENV
                  else
                      # é»˜è®¤åˆ†æ”¯
                      tag=mediatek-filogic-openwrt-24.10.2
                  fi
                  ;;
            esac
          
            docker run --rm -i \
              --user root \
              -v "${{ github.workspace }}/bin:/home/build/immortalwrt/bin" \
              -v "${{ github.workspace }}/mediatek-filogic/files/etc/uci-defaults:/home/build/immortalwrt/files/etc/uci-defaults" \
              -v "${{ github.workspace }}/mediatek-filogic/files/etc/config:/home/build/immortalwrt/files/etc/config" \
              -v "${{ github.workspace }}/arch/arch.conf:/home/build/immortalwrt/files/etc/opkg/arch.conf" \
              -v "${{ github.workspace }}/shell:/home/build/immortalwrt/shell" \
              -v "${{ github.workspace }}/mediatek-filogic/build24.sh:/home/build/immortalwrt/build.sh" \
              -e PROFILE=$profile \
              -e INCLUDE_DOCKER=$include_docker \
              -e USE_XR30_LED_DTS=${{ github.event.inputs.USE_XR30_LED_DTS }} \
              -e WIFI_DRIVER_VERSION=${{ env.wifi_driver_version }} \
              -e WIFI_DRIVER_FIRMWARE=${{ env.wifi_driver_firmware }} \
              -e USE_NX30PRO_EEPROM=${{ github.event.inputs.USE_NX30PRO_EEPROM }} \
              -e ENABLE_PPPOE=${{ github.event.inputs.enable_pppoe }} \
              -e PPPOE_ACCOUNT=${{ github.event.inputs.pppoe_account }} \
              -e PPPOE_PASSWORD=${{ github.event.inputs.pppoe_password }} \
            immortalwrt/imagebuilder:$tag /bin/bash /home/build/immortalwrt/build.sh
      
      - name: Create info
        run: |
          cat > ${{ github.workspace }}/router-info.md <<EOF
          ## ðŸ“¡ è·¯ç”±å™¨åŽå°ä¿¡æ¯

          - ðŸ  **åŽå°åœ°å€**: ${{ github.event.inputs.custom_router_ip }}
          - ðŸ‘¤ **ç”¨æˆ·å**: root
          - ðŸ”‘ **å¯†ç **: æ— 
          EOF

          if [ "${{ github.event.inputs.include_docker }}" == "true" ]; then
            extra_content="#### é»˜è®¤å¸¦docker"
            echo -e "\n$extra_content" >> ${{ github.workspace }}/router-info.md
          else
            echo -e "\n#### ä¸å¸¦docker" >> ${{ github.workspace }}/router-info.md
          fi
          
          echo "release_tag=${{ github.event.inputs.profile }}-$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
          
      - name: Upload ImmortalWrt as release assets
        uses: softprops/action-gh-release@v2.2.1
        with:
          tag_name: ${{ env.release_tag }}
          name: ImmortalWrt-Wireless
          body_path: ${{ github.workspace }}/router-info.md
          files: |
            ${{ github.workspace }}/bin/targets/${{ env.platform }}/*
          token: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
