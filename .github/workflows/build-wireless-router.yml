# æ­¤å·¥ä½œæµ99% ä½¿ç”¨luci 24.10.x æ¥æž„å»º æžä¸ªåˆ«æœºåž‹ä½¿ç”¨å¿«ç…§ç‰ˆå’Œ23.05.4ç‰ˆæœ¬æ¥æž„å»º
# 23.05.4 ç‰¹æœ‰æœºåž‹åˆ—è¡¨
# cmcc_rax3000m-emmc-ubootmod
# cmcc_rax3000m-nand-ubootmod

name: Build Wireless Router ImmortalWrt 24.10.x

on:
  workflow_dispatch:
    inputs:
      profile:
        type: choice
        description: "è¯·é€‰æ‹©mtkè·¯ç”±å™¨åž‹å·(cmcc_rax3000måœ¨24.10.2ä¸åŒºåˆ†emmcå’Œnandç‰ˆæœ¬)"
        required: true
        options:
          - cmcc_rax3000m
          - cmcc_rax3000m-emmc-ubootmod
          - cmcc_rax3000m-nand-ubootmod
          - cmcc_rax3000me
        default: cmcc_rax3000m
      custom_router_ip:
        description: "è¯·è®¾ç½®è·¯ç”±å™¨çš„ç®¡ç†åœ°å€ æ ¼å¼:192.168.x.1 æˆ– 10.x.x.1"
        required: true
        default: "192.168.6.1"
      enable_store:
        description: "æ˜¯å¦é›†æˆ iStore å•†åº—"
        required: false
        type: boolean
        default: true
      include_docker:
        description: "æ˜¯å¦ç¼–è¯‘ Docker æ’ä»¶"
        required: true
        default: true
        type: boolean
      USE_XR30_LED_DTS:
        description: "æ˜¯å¦ä½¿ç”¨XR30 Ledé…ç½®æ–‡ä»¶"
        required: true
        default: false
        type: boolean
      WIFI_DRIVER_VERSION:
        description: "é€‰æ‹©WiFié©±åŠ¨ç‰ˆæœ¬"
        required: true
        default: 'v7.6.7.2-fw-20240823(recommend)'
        type: choice
        options:
        - v7.6.7.2-fw-20240823(recommend)
        - v7.6.6.1-fw-20230306(recommend)
        - v7.6.7.2-fw-default
        - v7.6.7.2-fw-20230306
        - v7.6.7.2-fw-20230330
        - v7.6.7.2-fw-20230411
        - v7.6.7.2-fw-20230717
        - v7.6.7.2-fw-20231024
        - v7.6.6.1-fw-default
        - v7.6.6.1-fw-20230330
        - v7.6.6.1-fw-20230411
        - v7.6.6.1-fw-20230717
        - v7.6.6.1-fw-20231024
        - v7.6.6.1-fw-20240823
      USE_NX30PRO_EEPROM:
        description: "ä½¿ç”¨nx30proé«˜åŠŸèƒ½eepromæé«˜ä¿¡å·å¼ºåº¦"
        required: true
        default: false
        type: boolean
      SSH_TO_GITHUB_ACTIONS:
        description: "SSH connection to Actions"
        required: false
        default: false
        type: boolean
      enable_pppoe:
        description: "æ˜¯å¦é…ç½®PPPoEæ‹¨å·ä¿¡æ¯?"
        required: true
        default: false
        type: boolean
      pppoe_account:
        description: "å®½å¸¦è´¦å· (è‹¥å¯ç”¨PPPoE)"
        required: false
      pppoe_password:
        description: "å®½å¸¦å¯†ç  (è‹¥å¯ç”¨PPPoE)"
        required: false


jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      actions: write
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set executable permissions
        run: |
          chmod +x ${{ github.workspace }}/mediatek-filogic/build24.sh
      
      - name: Save Custom Router IP into OpenWrt files
        run: |
          mkdir -p "${{ github.workspace }}/custom"
          echo "${{ github.event.inputs.custom_router_ip }}" > "${{ github.workspace }}/custom/custom_router_ip.txt"
          echo "æ‚¨è®¾ç½®çš„è·¯ç”±å™¨ç®¡ç†åœ°å€æ˜¯:${{ github.event.inputs.custom_router_ip }}"
          # åŽç»­æ­¥éª¤ä¼šå°†è¯¥æ–‡ä»¶æ˜ å°„åˆ°è·¯ç”±å™¨/etc/config/custom_router_ip.txt ä»¥ä¾¿ç”¨äºŽå¼€æœºè„šæœ¬99-custom.shè¯»å–ç”¨æˆ·è®¾ç½®çš„ip


      - name: Validate PPPoE Inputs
        if: github.event.inputs.enable_pppoe == 'true'
        run: |
          if [[ -z "${{ github.event.inputs.pppoe_account }}" || -z "${{ github.event.inputs.pppoe_password }}" ]]; then
            echo "Error: PPPoE account and password must be provided when PPPoE is enabled!"
            exit 1
          fi
      
      - name: Enable Store integration
        if: github.event.inputs.enable_store == 'true'
        run: |
          echo 'CUSTOM_PACKAGES="$CUSTOM_PACKAGES luci-app-store"' >> shell/custom-packages.sh
          echo "âœ… å·²è¿½åŠ  luci-app-store"
      
      - name: Set Use XR30 LED DTS file
        if: github.event.inputs.USE_XR30_LED_DTS == 'true'
        run: |
          echo "âœ… è®¾ç½®ä½¿ç”¨XR30çš„Ledé…ç½®æ–‡ä»¶"
      
      - name: Set WiFi Driver Version

        run: |
          driver_version=$(echo "${{ github.event.inputs.WIFI_DRIVER_VERSION }}" | sed -E 's/^(v[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          driver_firmware=$(echo "${{ github.event.inputs.WIFI_DRIVER_VERSION }}" | sed -E 's/.*fw-([0-9]{8}|default).*/\1/g')
          echo "wifi_driver_version=$driver_version" >> $GITHUB_ENV
          echo "wifi_driver_firmware=$driver_firmware" >> $GITHUB_ENV
          echo "âœ… æ‚¨é€‰æ‹©çš„WiFié©±åŠ¨ç‰ˆæœ¬æ˜¯: $driver_version-fw-$driver_firmware"
 
      - name: Use nx30pro eeprom and fixed WiFi MAC address
        run: |
          if [ "${{ github.event.inputs.USE_NX30PRO_EEPROM }}" == "true" ]; then
            echo "âœ… ä½¿ç”¨nx30proçš„é«˜åŠŸçŽ‡eeprom(2.4Gæ˜¯23dBmã€5Gæ˜¯22dBm)"
          else
            echo "âŽ ä½¿ç”¨é»˜è®¤åŠŸçŽ‡eeprom(2.4Gæ˜¯25dBmã€5Gæ˜¯24dBm)"
          fi
      
      - name: Build Wireless ImmortalWrt 24.10.2
        id: compile
        run: |
          # é»˜è®¤å¹³å°
          echo "platform=mediatek/filogic" >> $GITHUB_ENV

          # é»˜è®¤åˆ†æ”¯
          tag=mediatek-filogic-openwrt-24.10.2
          branch=24.10.2

          # åˆ¤æ–­æœºåž‹
          echo "Building for profile: $profile"
          profile="${{ github.event.inputs.profile }}"
          case "$profile" in
              # ä¸‹åˆ—æœºåž‹ç›®å‰æ²¡æœ‰24.10 å› æ­¤é‡‡ç”¨23.05.4åˆ†æ”¯æ¥æž„å»º
              cmcc_rax3000m-emmc-ubootmod | \
              cmcc_rax3000m-nand-ubootmod)
                tag=mediatek-filogic-openwrt-23.05.4
                ls ${{ github.workspace }}/mediatek-filogic/
                cp ${{ github.workspace }}/mediatek-filogic/build23.sh ${{ github.workspace }}/mediatek-filogic/build24.sh
                ;;
              *)
          esac

          echo "repo_url=https://github.com/immortalwrt/immortalwrt" >> $GITHUB_ENV
          echo "repo_branch=$branch" >> $GITHUB_ENV
          
          docker run --rm -i \
            --user root \
            -v "${{ github.workspace }}/bin:/home/build/immortalwrt/bin" \
            -v "${{ github.workspace }}/mediatek-filogic/files/etc/uci-defaults:/home/build/immortalwrt/files/etc/uci-defaults" \
            -v "${{ github.workspace }}/mediatek-filogic/files/etc/config:/home/build/immortalwrt/files/etc/config" \
            -v "${{ github.workspace }}/arch/arch.conf:/home/build/immortalwrt/files/etc/opkg/arch.conf" \
            -v "${{ github.workspace }}/shell:/home/build/immortalwrt/shell" \
            -v "${{ github.workspace }}/mediatek-filogic/build24.sh:/home/build/immortalwrt/build.sh" \
            -e PROFILE=$profile \
            -e INCLUDE_DOCKER=${{ github.event.inputs.include_docker }} \
            -e USE_XR30_LED_DTS=${{ github.event.inputs.USE_XR30_LED_DTS }} \
            -e WIFI_DRIVER_VERSION=${{ env.wifi_driver_version }} \
            -e WIFI_DRIVER_FIRMWARE=${{ env.wifi_driver_firmware }} \
            -e USE_NX30PRO_EEPROM=${{ github.event.inputs.USE_NX30PRO_EEPROM }} \
            -e ENABLE_PPPOE=${{ github.event.inputs.enable_pppoe }} \
            -e PPPOE_ACCOUNT=${{ github.event.inputs.pppoe_account }} \
            -e PPPOE_PASSWORD=${{ github.event.inputs.pppoe_password }} \
          immortalwrt/imagebuilder:$tag /bin/bash /home/build/immortalwrt/build.sh

          echo "build_date=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: å‡†å¤‡é˜¶æ®µï¼šæ˜¯å¦å…è®¸é€šè¿‡SSH è¿žæŽ¥åˆ° Github Actions
        if: github.event.inputs.SSH_TO_GITHUB_ACTIONS == 'true'
        uses: alan6288/ssh2actions@main
        with:
          mode: ngrok
        env:
          # After sign up on the https://ngrok.com
          # You can find this token here: https://dashboard.ngrok.com/auth/your-authtoken
          NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}
          
          # ngrok server region [us, eu, au, ap, sa, jp, in] (optional, default: us)
          # You can find this server region here: https://ngrok.com/docs#global-locations
          NGROK_REGION: us
      
          # This password you will use when authorizing via SSH
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
      
      - name: Organize firmware files
        id: organize
        if: steps.compile.outputs.status == 'success' && !cancelled()
        run: | 
          #cd /home/build/immortalwrt/bin/targets/*/*
          #cd ${{ github.workspace }}/bin/targets/${{ env.platform }}/*
          cd ${{ github.workspace }}/bin/targets/*/*
          rm -rf *.buildinfo
          rm -rf *.compilejson
          rm -rf *.json
          rm -rf *.manifest
          rm -rf packages

          # ä½¿ç”¨æ•´ç†åŽçš„æ–‡ä»¶è¿›è¡Œå‘å¸ƒï¼Œä»£æ›¿${{ github.workspace }}/bin/targets/${{ env.platform }}/*
          echo "firmware_dir=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT
      
      - name: Create release tag
        id: tag
        if: steps.organize.outputs.status == 'success' && !cancelled()
        run: |          
          touch ${{ github.workspace }}/release.txt
          echo "- ðŸ’» CPUæž¶æž„: aarch64_cortex-a53" >> release.txt
          echo "- ðŸ“‚ ä½¿ç”¨æºç ï¼š${{ env.repo_url }}" >> release.txt
          echo "- ðŸŒ³ ä½¿ç”¨åˆ†æ”¯ï¼š${{ env.repo_branch }}" >> release.txt
          echo "- â±ï¸ æž„å»ºæ—¶é—´: ${{ env.build_date }}"" >> release.txt
          echo "- ðŸ  ç™»å½•åœ°å€: http://${{ github.event.inputs.custom_router_ip }} or http://immortalwrt.lan" >> release.txt
          echo "- ðŸ‘¤ ç”¨æˆ·å: root" >> release.txt
          echo "- ðŸ”’ å¯†ç : none" >> release.txt
          echo "- ðŸ“’ è¯´æ˜Ž: " >> release.txt
          if [ "${{ github.event.inputs.enable_store }}" == "true" ]; then
                  echo "- âœ… å·²æž„å»ºiStroeå•†åº—" >> release.txt
          else
                  echo "- âšªï¸ æœªæž„å»ºiStroeå•†åº—" >> release.txt
          fi
          if [ "${{ github.event.inputs.include_docker }}" == "true" ]; then
                  echo "- âœ… å·²æž„å»ºDocker" >> release.txt
          else
                  echo "- âšªï¸ æœªæž„å»ºDocker" >> release.txt
          fi

          echo "release_tag=${{ github.event.inputs.profile }}-$release_date" >> $GITHUB_OUTPUT
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Upload ImmortalWrt as release assets
        uses: softprops/action-gh-release@v2.2.1
        if: steps.tag.outputs.status == 'success' && !cancelled()
        with:
          name: ImmortalWrt-Wireless
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: ${{ github.workspace }}/realease.txt
          files: ${{ env.firmware_dir }}/*
          token: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
